# WireGuard + Go Controller (k3s) — Rough Plan

> **Status: In Development**
>
> Goal: Run **WireGuard** on the Pi node with the most resources; run a **Go-based admin UI** inside k3s that talks directly to the WG server to manage peers. Admin auth is simple (single root/admin user from k8s Secret). UI is reachable only after connecting to the VPN (or by `kubectl port-forward`).
>
> The admin UI will be reachable via the subdomain **vpn.knfolio.dev**.

---

## Work Split (Team Tasks)

### @KShiMin (learning focus: gRPC, Docker, basics of k3s)

- Build **docker-compose** for WireGuard service
  - Bring up WG container, configure UDP 51820, enable IP forwarding
  - Verify a peer can connect
- Extend docker-compose for a simple dev stack (WG + placeholder agent)
- Learn basics of gRPC
  - Generate Go stubs from `.proto`
  - Write a small test client/server
- Build **UI** (Go)
  - Build the gRPC client layer, handle login/authentication, and implement the peers list page.
  - Work together on templates, styling, and final deployment
- Kubernetes basics
  - Create namespace, Secret, PVC
  - Practice `kubectl port-forward` and deploy simple pods

### @Cyrof

- Build **WireGuard agent** (Go, systemd on gateway node)
  - gRPC server bound to Unix socket
  - Implement peer CRUD via `wgctrl`
- Build **Controller/UI** (Go, k3s deployment)
  - gRPC client to agent
  - Implement add/remove peer flows, QR code + config download, and handle middleware/security.
  - Work together on templates, styling, and final deployment.
- Create k3s manifests
  - Namespace, Secret, PVC, Deployment, Service
  - NodeSelector + hostPath for agent socket
- Handle image build for UI (Dockerfile + DockerHub push)
- Oversee security hardening (session cookies, rate limiting, TLS, Secrets handling)

## 1) High-Level Architecture

- **Gateway node (e.g., `knode3`)**
  - OS-level WireGuard service: `wg-quick@wg0` (systemd)
  - UDP `51820` forwarded from home router → `knode3`
  - Linux routing/NAT enabled (for VPN clients to reach cluster + LAN)
- **k3s cluster**
  - Namespace: `net` (for controller)
  - Deployment: `wg-controller` (Go app, REST + minimal HTML UI)
  - Service: `ClusterIP` (UI not publicly exposed directly; reachable via `vpn.knfolio.dev` subdomain inside VPN)
  - Node pinning: `wg-controller` scheduled on the gateway node
  - Secret: `wg-controller-admin` (bcrypt hash + optional TOTP secret)
- **Clients**
  - Use `.conf`/QR generated by the controller
  - Reach ClusterIPs/Pods and optionally the LAN

---

## 2) Networks & Addressing

- **LAN:** `192.168.70.0/24` (example; Pis have static: `.1`–`.4`)
- **WireGuard tunnel:** `10.8.0.0/24`
  - Server (gateway): `10.8.0.1/24`
  - Peers: `/32` (e.g., `10.8.0.10/32`)
- **k3s defaults (unless changed)**
  - Pods: `10.42.0.0/16`
  - Services: `10.43.0.0/16`
- **DNS**
  - Subdomain: `vpn.knfolio.dev` → WAN IP (optional but recommended)
  - Folio/public stays on TCP 80/443 via ingress; WG uses UDP 51820 (no conflict)

---

## 3) Router & Host Configuration

### Router/NAT

- **Forward:** UDP `51820` → `192.168.70.3` (or whichever gateway node)
- Keep existing TCP 80/443 forwards for ingress

### Gateway (host) — WireGuard

```ini
# /etc/wireguard/wg0.conf
[Interface]
Address = 10.8.0.1/24
ListenPort = 51820
PrivateKey = <SERVER_PRIVATE_KEY>
# Peers are added at runtime by the controller via wgctrl (no static [Peer] needed)
```

### Gateway (host) — sysctl + NAT

```bash
sudo sysctl -w net.ipv4.ip_forward=1
sudo sysctl -w net.ipv4.conf.all.src_valid_mark=1
sudo iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -j MASQUERADE

sudo systemctl enable wg-quick@wg0
sudo systemctl start wg-quick@wg0
```

> Persist sysctls in `/etc/sysctl.conf`. Persist NAT via nftables/iptables-save.

---

## 4) k3s Resources (controller)

### Namespace

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: net
```

### Secret (admin-only login)

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: wg-controller-admin
  namespace: net
type: Opaque
stringData:
  ADMIN_USERNAME: "admin"
  ADMIN_BCRYPT_HASH: "$2y$12$REPLACE_WITH_BCRYPT" # echo -n "password" | bcrypt
  # Optional TOTP seed (leave empty to disable 2FA initially)
  TOTP_SECRET: ""
```

### PVC (SQLite)

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: wg-controller-pvc
  namespace: net
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: 1Gi
```

### Deployment (pinned to gateway node)

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: wg-controller
  namespace: net
spec:
  replicas: 1
  selector:
    matchLabels: { app: wg-controller }
  template:
    metadata:
      labels: { app: wg-controller }
    spec:
      nodeSelector:
        kubernetes.io/hostname: knode3 # pin to WG gateway node
      containers:
        - name: controller
          image: ghcr.io/you/wg-controller:0.1.0
          ports:
            - containerPort: 8080
          env:
            - name: WG_IFACE
              value: "wg0"
            - name: WG_ENDPOINT
              value: "vpn.knfolio.dev:51820" # or your WAN IP:51820
            - name: DB_PATH
              value: "/data/controller.db"
          envFrom:
            - secretRef:
                name: wg-controller-admin
          volumeMounts:
            - name: data
              mountPath: /data
          securityContext:
            runAsNonRoot: true
            readOnlyRootFilesystem: true
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: wg-controller-pvc
```

### Service (ClusterIP; UI reachable only via VPN or port-forward)

```yaml
apiVersion: v1
kind: Service
metadata:
  name: wg-controller
  namespace: net
spec:
  type: ClusterIP
  selector:
    app: wg-controller
  ports:
    - port: 80
      targetPort: 8080
```

> Do not add an Ingress yet. Access UI by:
>
> - **"Connecting to VPN and browsing `http://10.8.0.1:8080` (if bound to wg IP), or**
> - **"`kubectl -n net port-forward svc/wg-controller 8080:80`"**

---

## 5) Go Controller — Scope & Design

### Features (v0)

- **Auth**
  - Single admin user (`ADMIN_USERNAME` + `ADMIN_BCRYPT_HASH`)
  - Cookie session (HttpOnly, SameSite=Strict; `Secure` when behind TLS)
  - Optional TOTP (if `TOTP_SECRET` non-empty)

- **Peers CRUD**
  - Create peer: allocates `10.8.0.x/32`, generates client keypair, sets AllowedIPs, applies via wgctrl, returns `.conf` + QR
  - List peers: name, pubkey, address, allowed CIDRs, last handshake
  - Revoke peer: remove via wgctrl

- **Config Profiles (optional, v0.1)**
  - Predefined “scopes”: `folio-only` (`10.43.250.87/32`), `cluster` (`10.42.0.0/16,10.43.0.0/16`), `cluster+lan` (+`192.168.70.0/24`)

- **No storage of client private keys** (show once; discard)

### API (gRPC instead of REST)

- `AddPeer(AddPeerRequest) returns (AddPeerResponse)`
- `ListPeers(ListPeersRequest) returns (ListPeersResponse)`
- `RemovePeer(RemovePeerRequest) returns (RemovePeerResponse)`
- All RPCs gated behind authentication (session + middleware)

### Storage

- SQLite at `/data/controller.db`
  - `peers(id, name, pubkey, address, allowed_json, created_at, revoked_at)`
  - `ip_alloc(state)` for simple IP pool tracking

### Libraries (suggested)

- gRPC: `google.golang.org/grpc`
- WG control: `golang.zx2c4.com/wireguard/wgctrl`
- Auth: `golang.org/x/crypto/bcrypt`
- TOTP: `github.com/pquerna/otp/totp`
- QR: `github.com/skip2/go-qrcode`
- Web: Fiber or Gin for serving the HTML UI, backend by gRPC calls

### UI (minimal)

- Pages:
  - `/login` (username, password, TOTP if enabled)
  - `/peers` list (name, address, allowed, last handshake, actions)
  - `/peers/new` form:
    - name
    - allowed preset (dropdown) or custom CIDR list
    - submit → show config (textarea + “Download .conf”) + QR image

- Style: simple Tailwind or minimal CSS, keep it functional

---

## 6) Security Posture

- **UI exposure**
  - Default: **not** on the public internet
  - Access via VPN or `kubectl port-forward`

- **Admin user**
  - Provisioned via Secret env; **no other users**

- **Sessions**
  - Cookie flags: HttpOnly + SameSite=Strict (+ Secure if HTTPS)
  - Add basic rate limiting on `/login`

- **AllowedIPs minimization**
  - Prefer least-privilege presets (e.g., folio-only)

- **Server key rotation (later)**
  - Implement maintenance action to rotate server key and re-issue peers

- **Backups**
  - Periodic backup of SQLite PVC (cronjob or external)

## 7) Bring-Up Sequence

**1. Pick gateway node** (e.g., `knode3`) with most resources

**2. Install WireGuard on host**; create `/etc/wireguard/wg0.conf`; enable IP forwarding + NAT

**3. Router**: forward UDP 51820 → gateway node

**4. DNS (optional)**: create `vpn.knfolio.dev` A record → WAN IP

**5. Deploy controller** (`Namespace`,`Secret`, `PVC`, `Deployment`, `Service`)

**6. Test peer add (manual)**

- Create peer with `AllowedIPs = 10.43.250.87/32` (folio-only)
- Import config on laptop; `curl http://10.43.250.87:3000`

**7. Broaden AllowedIPs** as needed (Pods/Services/LAN)

---

## 8) Operational Notes

- **Node usage**: gateway node still schedules normal k3s workloads
  - If desired, add taint `role=net:PreferNoSchedule` and add toleration only to controller

- **Performance**: monitor CPU when multiple clients transfer; migrate gateway role if needed

- **Observability (nice-to-have)**:
  - Expose Prometheus metrics: peers count, bytes in/out, last_handshake
  - UI page to show live `wg show` output

---

## 9) Roadmap (Later)

- Internal DNS for friendly names (tiny CoreDNS instance or controller-provided hosts)
- Per-peer expiration/auto-disable
- Server key rotation workflow
- Export `.mobileconfig` (Apple) / per-OS packaging helpers
- Switch SQLite → Postgres if multi-instance control plane is desired
- Optional SSO (OIDC) while still keeping admin seeded via Secret

---

## 10) Quick Reference — Client Config Template

```ini
# client.conf
[Interface]
PrivateKey = <CLIENT_PRIVATE_KEY>
Address = 10.8.0.X/32
DNS = 10.8.0.1      # optional if you add internal DNS later

[Peer]
PublicKey = <SERVER_PUBLIC_KEY>
Endpoint = vpn.knfolio.dev:51820   # or <WAN_IP>:51820
AllowedIPs = 10.43.250.87/32       # start tight (folio-only); expand as needed
PersistentKeepalive = 25
```

## 11) Acceptance Checklist

- [ ] UDP 51820 forwarded to gateway node

- [ ] `wg0` up with server key, `10.8.0.1/24` assigned

- [ ] `ip_forward=1` and MASQUERADE for `10.8.0.0/24`

- [ ] Controller deployed; admin login works

- [ ] Create peer → download `.conf` + QR → client connects

- [ ] Client can reach selected resources (folio/cluster/LAN as intended)

- [ ] UI not publicly exposed (VPN-only or port-forward)

- [ ] Secrets stored only in k8s Secret (no plaintext in repo)
